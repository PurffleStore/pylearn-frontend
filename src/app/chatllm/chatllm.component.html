<!-- chatllm.component.html (FULL FILE) -->

<div class="staticchat-container">
  <img routerLink="/" src="assets/staticchat/home.png" class="back-btn" />

  <div class="nav-bar"> Speech Tutor</div>

  <div class="chat-container">
    <div class="chat-window">
      <!-- Prev -->
      <img
        src="assets/staticchat/up.png"
        class="arrow-btn up"
        title="Prev message"
        (click)="showPreviousPair()"
      />

      <!-- MESSAGES -->
      <div class="chat-messages" #chatContainer>
        <div
          *ngFor="let pair of pairedMessagesList; let i = index; trackBy: trackByPair"
          class="pair"
          [attr.data-index]="i"
        >
          <!-- User (top) -->
          <div *ngIf="pair.user" class="message-row user-row">
            <div class="message-bubble user-message">
              <span style="font-size:1.5vw;">{{ pair.user.text }}</span>
              <div class="message-time">{{ pair.user.timestamp | date:'shortTime' }}</div>
            </div>
            <img src="assets/staticchat/student.png" class="avatar" />
          </div>

          <!-- Bot (bottom) -->
          <div *ngIf="pair.bot" class="message-row bot-row">
            <img src="assets/staticchat/teacher.png" class="avatar" />
            <div class="message-bubble bot-message">
              <!-- Normal bot text OR typing dots -->
<ng-container *ngIf="!pair.bot._isTyping; else typingTpl">
  <span fitText [fitTextMaxVw]="1.5" [fitTextMinPx]="12">{{ pair.bot.text }}</span>
</ng-container>

<ng-template #typingTpl>
  <div class="typing-inline">
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
  </div>
</ng-template>

              <!-- Media buttons (ONE BUTTON PER TYPE, plays arrays one-by-one automatically) -->
              <div
                class="mediaRow"
                *ngIf="pair.bot.rawData &&
                  (pair.bot.rawData?.audio_urls?.length > 0 ||
                   pair.bot.rawData?.video_urls?.length > 0 ||
                   pair.bot.rawData?.detail_urls?.length > 0 ||
                   pair.bot.rawData?.story_urls?.length > 0 ||
                   pair.bot.rawData?.example_urls?.length > 0 ||
                   pair.bot.rawData?.audio_url ||
                   pair.bot.rawData?.video_url ||
                   pair.bot.rawData?.detail_url ||
                   pair.bot.rawData?.story_url ||
                   pair.bot.rawData?.example_url)"
              >
                <!-- ONE AUDIO -->
                <button
                  type="button"
                  class="chip audio-btn"
                  *ngIf="pair.bot.rawData?.audio_urls?.length > 0 || pair.bot.rawData?.audio_url"
                  (click)="startPlaylist(pair.bot, 'audio')"
                >
                  üîä Audio
                </button>

                <!-- ONE MAIN VIDEO -->
                <button
                  type="button"
                  class="chip video-btn"
                  *ngIf="pair.bot.rawData?.video_urls?.length > 0 || pair.bot.rawData?.video_url"
                  (click)="startPlaylist(pair.bot, 'video')"
                >
                  üé¨ Video
                </button>

                <!-- ONE DETAIL -->
                <button
                  type="button"
                  class="chip detail-btn"
                  *ngIf="pair.bot.rawData?.detail_urls?.length > 0 || pair.bot.rawData?.detail_url"
                  (click)="startPlaylist(pair.bot, 'detail')"
                >
                  üí° Detail
                </button>

                <!-- ONE STORY -->
                <button
                  type="button"
                  class="chip story-btn"
                  *ngIf="pair.bot.rawData?.story_urls?.length > 0 || pair.bot.rawData?.story_url"
                  (click)="startPlaylist(pair.bot, 'story')"
                >
                  üìñ Story
                </button>

                <!-- ONE EXAMPLE -->
                <button
                  type="button"
                  class="chip example-btn"
                  *ngIf="pair.bot.rawData?.example_urls?.length > 0 || pair.bot.rawData?.example_url"
                  (click)="startPlaylist(pair.bot, 'example')"
                >
                  üß™ Example
                </button>
              </div>

              <div class="message-time">{{ pair.bot.timestamp | date:'shortTime' }}</div>
            </div>
          </div>
        </div>

      
       
      </div>

      <!-- Next -->
      <img
        src="assets/staticchat/down.png"
        class="arrow-btn down"
        title="Next message"
        (click)="showNextPair()"
      />

      <!-- SUGGESTIONS (FIXED: mousedown) -->
      <div *ngIf="showSuggestions && suggestedQuestions.length > 0" class="suggestions-box">
        <div
          *ngFor="let question of suggestedQuestions"
          class="suggestion-item"
          (mousedown)="selectQuestion(question); $event.preventDefault(); $event.stopPropagation();"
        >
          {{ question }}
        </div>
      </div>

      <!-- INPUT BAR -->
      <form [formGroup]="chatForm" (ngSubmit)="sendMessage()" class="chat-input">
        <input
          type="text"
          formControlName="message"
          #messageInput
          [placeholder]="isListening ? '‚è∫ Listening...' : 'Type your message...'"
          (click)="onInputClick()"
          (blur)="onInputBlur()"
          (input)="onInputChange()"
          [readonly]="isSpeechProcessing || isListening"
        />

        <!-- Mic -->
        <button
          type="button"
          class="micBtn"
          [disabled]="!supported || isListening"
          (click)="toggleMic()"
        >
          üé§
        </button>

        <!-- Accept/Reject -->
        <div class="actions" *ngIf="showActions">
          <button
            type="button"
            class="reject"
            (click)="reject(); $event.preventDefault(); $event.stopPropagation();"
          >
            ‚ùå
          </button>
          <button
            type="button"
            class="accept"
            (click)="accept(); $event.preventDefault(); $event.stopPropagation();"
          >
            ‚úÖ
          </button>
        </div>

        <!-- Send -->
        <button type="submit" [disabled]="!chatForm.valid">‚û§</button>
      </form>
    </div>

    <!-- VIDEO WINDOW -->
    <div class="video-window">
      <video #videoPlayer autoplay muted playsinline></video>
      <img
        class="play-pause-btn"
        [src]="(currentVideoType !== 'blink' && isVideoPlaying) ? 'assets/staticchat/pause.png' : 'assets/staticchat/play.png'"
        (click)="togglePlayPause()"
      />
    </div>
  </div>
</div>